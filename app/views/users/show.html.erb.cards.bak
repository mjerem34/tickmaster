<% if !current_user.nil? %>
  <% @title = "Mes incidents"%>
 <% if @incidents.count > 0 %>
<div class="tri-cards-list-incidents">
  <%= select_tag 'Tri', "
  <option data-tri='id desc'>Récents</option>
  <option data-tri='id asc'>Anciens</option>
  <option data-tri='title asc'>Objet: A à Z</option>
  <option data-tri='title desc'>Objet Z à A</option>
  <option data-tri='content asc'>Contenu: A à Z</option>
  <option data-tri='content desc'>Contenu: Z à A</option>
  <option data-tri='users.name asc'>Demandeur: A à Z</option>
  <option data-tri='users.name desc'>Demandeur: Z à A</option>
  <option data-tri='categories.name asc'>Catégorie: A à Z</option>
  <option data-tri='categories.name desc'>Catégorie: Z à A</option>
  <option data-tri='sous_categories.name asc'>Sous-catégorie: A à Z</option>
  <option data-tri='sous_categories.name desc'>Sous-catégorie: Z à A</option>
  <option data-tri='incident_state_id_for_tech_id asc'>Etat &#9650;</option>
  <option data-tri='incident_state_id_for_tech_id desc'>Etat &#9660;</option>
  <option data-tri='lvl_urgence_user asc'>Priorité &#9650;</option>
  <option data-tri='lvl_urgence_user desc'>Priorité &#9660;</option>
  ", include_blank: "Trier par :", class: "form-control select-tri-cards-list-incidents"%>
</div>

  <div class="cards-list-incidents">
  <% @incidents.each do |incident| %>
  <% case incident.incident_state_id_for_tech.id %>
  <% when 1 %>
    <div class="col-md-4 card-incident" style=" background: #f44336;">
  <% when 2 %>
    <div class="col-md-4 card-incident" style="background: #4CAF50;">
  <% when 4 %>
    <div class="col-md-4 card-incident" style="background: #FFEB3B; color:#212121;">
    <% else %>
    <div class="col-md-4 card-incident" style="background: #335f87; ">
  <% end %>
    <div class="firstPart" onClick="document.location.href='<%=edit_incident_path(incident)%>'">

          <p> N°<%= incident.id %></p><br>
          <p class="hover-cellule" style="word-break: break-all;">Objet : <b><%= truncate(incident.title, length: 70) %></b></p>
          <p class="hover-cellule" style="word-break: break-all;">Contenu : <b><%= truncate(strip_tags(incident.content), length: 100)%></b></p>
          <p>Demandeur : <b><%= incident.user.name%> <%= incident.user.surname%></b></p>
          <% if !incident.tech.nil? %>
          <p>Technicien : <b><%= incident.tech.name %> <%= incident.tech.surname %></b></p>
          <% else %>
          <p>Technicien : <b>Technicien non défini ...</b></p>
          <% end %>
        </div>
        <div class="secondPart" onClick="document.location.href='<%=edit_incident_path(incident)%>'">
          <p>Catégorie : <b><%= incident.category.name %></b></p>
          <p>Sous-Categorie : <b><%= incident.sous_category.name%></p>
          <p>Date : <b><%= incident.created_at.strftime("%d %b %Y %H:%M")%></b></p>
          <p>Etat : <b><%= incident.incident_state_id_for_tech.shortcut %></b></p>
          <p>Urgence : <b><%= incident.lvl_urgence_user %></b></p>
        </div>
  </div>
  <% end %>

</div>
<script type="text/javascript">
$(document).ready(function(){
  $(".select-tri-cards-list-incidents").change(function(){
    $.ajax({
      url: '/users/<%= current_user.id %>',
      type: 'GET',
      dataType: 'script',
      data: {
        order_by: $(".select-tri-cards-list-incidents option:selected").attr("data-tri")
      }
    });
  });
});
</script>
<% else %>
<div class="row">
  <div class="col-md-12 aucun-incident-div"><h1>
    Vous n'avez aucun incident actif pour le moment.
  </h1></div>
</div>
<% end %>

<% else %>
<% @title = "Accès non autorisé"%>
<%= flash.now[:alert] = "Vous n'avez pas l'autorisation d'accéder à cette page" %>
<% end %>
