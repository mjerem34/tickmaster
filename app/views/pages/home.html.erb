<% if !current_user.nil? %>
<% @title = 'Tableau de bord' %>
<% @incidents = Incident.all.order("created_at asc") %>
<% @incidents_without_tech = @incidents.where(tech_id: nil).includes(:user, :category, :sous_category).order("created_at asc") %>
<% @incidents_to_treat = @incidents.where(tech_id: current_user.id, incident_state_id_for_user_id: [2, 3, 4, 5, 6, 11, 12]).limit(20).includes(:user, :category, :sous_category).order("created_at asc") %>
<br>
<div class="tableau-de-bord">
<div class="row">
  <div class="col-md-4 col-sm-6 col-xs-12">
    <label>Derniers incidents</label>
    <div class="table-responsive">
    <table class="table">
      <thead class="header">
        <tr>
          <th>Demandeur</th>
          <th>Technicien</th>
          <th>Categorie</th>
          <th>Etat</th>
          <th>Urgence</th>
        </tr>
      </thead>
      <tbody>
        <% for incident in @incidents do %>
        <tr>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.user.name %></td>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.tech.nil? ? "" : incident.tech.name %></td>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.category.name %></td>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.incident_state_id_for_tech.name %></td>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.lvl_urgence_tech %></td>
        </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
  <div class="col-md-4 col-sm-6 col-xs-12">
    <label>Incidents non attribu√©s</label>
    <div class="table-responsive">
    <table class="table">
      <thead class="header">
        <tr>
          <th>Demandeur</th>
          <th>Technicien</th>
          <th>Categorie</th>
          <th>Etat</th>
          <th>Urgence</th>
        </tr>
      </thead>
      <tbody>
        <% for incident in @incidents_without_tech do %>
        <tr>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.user.name %></td>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.tech.nil? ? "" : incident.tech.name %></td>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.category.name %></td>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.incident_state_id_for_tech.name %></td>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.lvl_urgence_tech %></td>
        </tr>
        <% end %>
      </tbody>
    </table>
  </div>

</div>
  <div class="col-md-4 col-sm-6 col-xs-12">
    <label>Incidents a traiter</label>
    <div class="table-responsive">
    <table class="table">
      <thead class="header">
        <tr>
          <th>Demandeur</th>
          <th>Categorie</th>
          <th>Etat</th>
          <th>Urgence</th>
        </tr>
      </thead>
      <tbody>
        <% for incident in @incidents_to_treat do %>
        <tr>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.user.name %></td>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.category.name %></td>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.incident_state_id_for_tech.name %></td>
          <td class="hover-cellule <%= 'agency.id' %>" data-toggle="modal" data-target="#<%= 'agency.id' %>"><%= incident.lvl_urgence_tech %></td>
        </tr>
        <% end %>
      </tbody>
    </table>
  </div>

</div>
</div>
<div class="row">
  <div class="col-md-4 col-sm-6 col-xs-12"> <%= area_chart @incidents.group_by_day(:created_at).count %></div>
  <!-- <div class="col-md-4 col-sm-6 col-xs-12">pie_chart @incidents.group(:agency).count</div> -->
  <div class="col-md-4 col-sm-6 col-xs-12"></div>
</div>

<% else %>
<% @title = 'Accueil' %>
<% content_for :accueil do %>
<%= render 'sessions/new' %>
<% end %>
<% end %>
<script type="text/javascript">
  $(document).ready(function () {
    $("#list_for_disp").hide();
    $("a.details").click(function () {
      $("#list_for_disp").toggle();
    });
  });
</script>
</div>
