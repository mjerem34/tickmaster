!function(e){"use strict";var t=e.tablesorter.editable={namespace:".tseditable",lastEdited:"tseditable-last-edited-cell",editComplete:function(e,n,i,o){e.$table.find("."+t.lastEdited).removeClass(t.lastEdited).trigger(n.editable_editComplete,[e]),o&&setTimeout(function(){i.focus()},50)},selectAll:function(e){setTimeout(function(){var t,n;document.body.createTextRange?(t=document.body.createTextRange(),t.moveToElementText(e),t.select()):window.getSelection&&(n=window.getSelection(),t=document.createRange(),t.selectNodeContents(e),n.removeAllRanges(),n.addRange(t))},100)},getColumns:function(t,n){var i,o,a,l,d,r=n.editable_columns,s=[];if("string"==typeof r)for(i=r.replace(/\s+/,"").split(/,/),l=i.length-1;l>=0;){if(i[l].indexOf("-")>=0)for(a=i[l].split("-"),o=parseInt(a[0],10)||0,a=parseInt(a[1],10)||t.columns-1,o>a&&(d=o,o=a,a=d);a>=o;o++)s.push("td:nth-child("+(o+1)+")");else s.push("td:nth-child("+((parseInt(i[l],10)||0)+1)+")");l--}else if(e.isArray(r))for(l=r.length,o=0;l>o;o++)r[o]<t.columns&&s.push("td:nth-child("+(r[o]+1)+")");return s},update:function(n,i){var o,a,l,d,r,s,c,u=e("<div>").wrapInner(i.editable_wrapContent).children().length||e.isFunction(i.editable_wrapContent),b=t.getColumns(n,i).join(",");for(n.$tbodies.find(b).find("[contenteditable]").prop("contenteditable",!1),a=n.$tbodies.find(b).not("."+i.editable_noEdit),d=a.length,l=0;d>l;l++)if(o=a.eq(l),u&&0===o.children("div, span").length&&o.wrapInner(i.editable_wrapContent),r=o.children("div, span").not("."+i.editable_noEdit),c=r.length)for(s=0;c>s;s++){var f=r.eq(s);i.editable_trimContent&&f.html(function(t,n){return e.trim(n)}),f.prop("contenteditable",!0)}else i.editable_trimContent&&o.html(function(t,n){return e.trim(n)}),o.prop("contenteditable",!0)},bindEvents:function(n,i){var o=t.namespace;n.$table.off("updateComplete pagerComplete ".split(" ").join(o+" ").replace(/\s+/g," ")).on("updateComplete pagerComplete ".split(" ").join(o+" "),function(){t.update(n,n.widgetOptions)}).children("thead").add(e(n.namespace+"_extra_table").children("thead")).off("mouseenter"+o).on("mouseenter"+o,function(){n.$table.data("contentFocused")&&(n.$table.data("contentFocused",!0),e(":focus").trigger("focusout"))}),n.$tbodies.off("focus blur focusout keydown ".split(" ").join(o+" ").replace(/\s+/g," ")).on("focus"+o,"[contenteditable]",function(a){clearTimeout(e(this).data("timer")),n.$table.data("contentFocused",a.target),n.table.isUpdating=!0;var l=e(this),d=i.editable_selectAll,r=l.closest("td").index(),s=l.html();i.editable_trimContent&&(s=e.trim(s)),l.off("keydown"+o).on("keydown"+o,function(e){i.editable_enterToAccept&&13===e.which&&!e.shiftKey&&e.preventDefault()}),l.data({before:s,original:s}),"function"==typeof i.editable_focused&&i.editable_focused(s,r,l),d&&("function"==typeof d?d(s,r,l)&&t.selectAll(l[0]):t.selectAll(l[0]))}).on("blur focusout keydown ".split(" ").join(o+" "),"[contenteditable]",function(a){if(n.$table.data("contentFocused")){var l,d,r=!1,s=e(a.target),c=s.html(),u=s.closest("td").index();if(i.editable_trimContent&&(c=e.trim(c)),27===a.which)return s.html(s.data("original")).trigger("blur"+o),n.$table.data("contentFocused",!1),n.table.isUpdating=!1,!1;if(l=13===a.which&&!a.shiftKey&&(i.editable_enterToAccept||a.altKey)||i.editable_autoAccept&&"keydown"!==a.type,l&&s.data("before")!==c){if(d=i.editable_validate,r=c,"function"==typeof d?r=d(c,s.data("original"),u,s):"function"==typeof(d=e.tablesorter.getColumnData(n.table,d,u))&&(r=d(c,s.data("original"),u,s)),l&&r!==!1)return n.$table.find("."+t.lastEdited).removeClass(t.lastEdited),s.addClass(t.lastEdited).html(r).data("before",r).data("original",r).trigger("change"),n.table.hasInitialized&&e.tablesorter.updateCell(n,s.closest("td"),!1,function(){i.editable_autoResort?setTimeout(function(){e.tablesorter.sortOn(n,n.sortList,function(){t.editComplete(n,i,n.$table.data("contentFocused"),!0)},!0)},10):t.editComplete(n,i,n.$table.data("contentFocused"))}),!1}else r||"keydown"===a.type||(clearTimeout(s.data("timer")),s.data("timer",setTimeout(function(){n.table.isUpdating=!1,e.isFunction(i.editable_blur)&&(c=s.html(),i.editable_blur(i.editable_trimContent?e.trim(c):c,u,s))},100)),s.html(s.data("original")))}})},destroy:function(e,n){var i=t.namespace,o=t.getColumns(e,n),a="updateComplete pagerComplete ".split(" ").join(i+" ").replace(/\s+/g," ");e.$table.off(a),a="focus blur focusout keydown ".split(" ").join(i+" ").replace(/\s+/g," "),e.$tbodies.off(a).find(o.join(",")).find("[contenteditable]").prop("contenteditable",!1)}};e.tablesorter.addWidget({id:"editable",options:{editable_columns:[],editable_enterToAccept:!0,editable_autoAccept:!0,editable_autoResort:!1,editable_wrapContent:"<div>",editable_trimContent:!0,editable_validate:null,editable_focused:null,editable_blur:null,editable_selectAll:!1,editable_noEdit:"no-edit",editable_editComplete:"editComplete"},init:function(e,n,i,o){o.editable_columns.length&&(t.update(i,o),t.bindEvents(i,o))},remove:function(e,n,i,o){o||t.destroy(n,i)}})}(jQuery);
